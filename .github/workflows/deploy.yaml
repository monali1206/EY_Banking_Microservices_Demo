name: Build and Deploy Banking Services

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    # 1. Login to Docker Hub
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        # Ensure these secret names match exactly what you have in GitHub Settings
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # 2. Build and Push the Single Shared Image
    - name: Build and Push Image
      run: |
        # Generate a unique tag using the short commit hash
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        
        # REMOVED ':latest' from the IMAGE_NAME variable
        IMAGE_BASE=${{ secrets.DOCKERHUB_USERNAME }}/banking-kycservice-ey
        
        # Combine them correctly here
        FULL_IMAGE=$IMAGE_BASE:$SHORT_SHA
        
        echo "Building image: $FULL_IMAGE"
        
        # Build and Push
        docker build -t $FULL_IMAGE .
        docker push $FULL_IMAGE
        
        # Export for the next step (env variable)
        echo "FULL_IMAGE_NAME=$FULL_IMAGE" >> $GITHUB_ENV
        echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV

    # 3. Update Kubernetes Manifest (app.yaml)
    - name: Update Kubernetes Manifest
      run: |
        # Update every occurrence of 'image:' in your k8s/app.yaml
        sed -i "s|image: .*|image: ${{ env.FULL_IMAGE_NAME }}|g" k8s/app.yaml
        
        # Commit the change back to the repository
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        git add k8s/app.yaml
        git commit -m "chore: update image tag to ${{ env.SHORT_SHA }} [skip ci]"
        git push