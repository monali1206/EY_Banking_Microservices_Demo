name: Build and Deploy Banking Services

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    # 1. Login to Docker Hub
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # 2. Build and Push the Single Shared Image
    - name: Build and Push Image
      run: |
        # Generate a unique tag using the short commit hash
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        IMAGE_NAME=${{ secrets.DOCKER_USERNAME }}/fraud-engine
        
        # Build the image that contains all three app scripts
        docker build -t $IMAGE_NAME:$SHORT_SHA .
        docker push $IMAGE_NAME:$SHORT_SHA
        
        # Export for the next step
        echo "FULL_IMAGE_NAME=$IMAGE_NAME:$SHORT_SHA" >> $GITHUB_ENV

    # 3. Update Kubernetes Manifest (app.yaml)
    - name: Update Kubernetes Manifest
      run: |
        # This sed command finds every instance of 'image:' and updates it to the new tag
        # Specifically targets your placeholder pattern in app.yaml
        sed -i "s|image: .*|image: ${{ env.FULL_IMAGE_NAME }}|g" k8s/app.yaml
        
        # Commit the change back to the repository
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        git add k8s/app.yaml
        git commit -m "chore: update image tag to ${{ env.SHORT_SHA }} [skip ci]"
        git push